(function(){let isRegistered=false;const runMe=function($dotapp){if(isRegistered){console.warn("DotApp Reactive Engine already registered, skipping...");return}isRegistered=true;class ReactiveEndpoint{#element=null;#apiUrl="";#method="GET";#trigger=null;#variable=null;#interval=null;#intervalId=null;#key="";#id="";#data="";#dotAppInstance=null;#hooks={};#retryCount=0;#maxRetries=3;#retryDelay=1e3;#isLoading=false;#lastData=null;#template=null;#templatePath=null;constructor(dotAppInstance,element,config){this.#dotAppInstance=dotAppInstance;this.#element=element;this.#apiUrl=config.api||"";this.#method=(config.method||"GET").toUpperCase();this.#trigger=config.trigger||null;this.#variable=config.variable||null;this.#interval=config.interval?parseInt(config.interval):null;this.#key=config.key||"";this.#id=config.id||"";this.#data=config.data||"";this.#template=config.template||null;this.#templatePath=config.templatePath||null;this.#hooks={before:[],after:[],onError:[],onResponseCode:{}};this.#initialize()}#initialize(){if(this.#variable){const variable=this.#dotAppInstance.variable(this.#variable,null);if(variable){this.#variable=variable}}if(this.#interval&&this.#interval>0){this.#setupPolling()}if(this.#trigger){this.#setupEventTriggers()}else if(!this.#interval){this.#fetch()}}#setupPolling(){if(this.#intervalId){clearInterval(this.#intervalId)}this.#intervalId=setInterval(()=>{this.#fetch()},this.#interval)}#setupEventTriggers(){if(!this.#element)return;const triggers=Array.isArray(this.#trigger)?this.#trigger:[this.#trigger];triggers.forEach(triggerEvent=>{if(triggerEvent==="variable"){if(this.#variable&&this.#variable.onChange){this.#variable.onChange(()=>{this.#fetch()})}}else{if(typeof $dotapp!=="undefined"){$dotapp(this.#element).on(triggerEvent,()=>{this.#fetch()})}else{this.#element.addEventListener(triggerEvent,()=>{this.#fetch()})}}})}async#fetch(){if(this.#isLoading)return;this.#isLoading=true;this.#retryCount=0;if(this.#hooks.before.length>0){for(const fn of this.#hooks.before){try{await fn(this.#lastData,this.#element)}catch(e){console.warn("Error in before hook:",e)}}}try{await this.#performFetch()}catch(error){this.#handleError(error)}finally{this.#isLoading=false}}async#performFetch(){let apiUrl=this.#apiUrl;if(this.#data&&this.#key){try{apiUrl=this.#apiUrl}catch(e){console.warn("Failed to decrypt reactive-data, using provided URL")}}let responseData;try{if(this.#method==="GET"){responseData=await this.#dotAppInstance.load(apiUrl)}else{responseData=await this.#dotAppInstance.load(apiUrl,"POST",{})}}catch(error){const response=await fetch(apiUrl,{method:this.#method,headers:{"Content-Type":"application/x-www-form-urlencoded",dotreactive:"true"}});if(!response.ok){const statusCode=response.status;const errorText=await response.text();if(this.#hooks.onResponseCode[statusCode]){for(const fn of this.#hooks.onResponseCode[statusCode]){try{await fn(statusCode,errorText,this.#element)}catch(e){console.warn("Error in onResponseCode hook:",e)}}return}throw new Error(`HTTP ${statusCode}: ${errorText}`)}const responseText=await response.text();let parsedData=null;try{parsedData=JSON.parse(atob(responseText))}catch(e){try{parsedData=JSON.parse(responseText)}catch(e2){parsedData=responseText}}this.#lastData=parsedData;this.#retryCount=0;if(this.#variable&&this.#variable.value!==undefined){this.#variable.value=parsedData}if(this.#templatePath&&this.#element){await this.#renderTemplate(parsedData)}else if(this.#element&&!this.#variable){this.#element.innerHTML=typeof parsedData==="string"?parsedData:JSON.stringify(parsedData)}if(this.#hooks.after.length>0){for(const fn of this.#hooks.after){try{await fn(parsedData,this.#element)}catch(e){console.warn("Error in after hook:",e)}}}return}let parsedData=responseData;if(typeof responseData==="string"){try{parsedData=JSON.parse(atob(responseData))}catch(e){try{parsedData=JSON.parse(responseData)}catch(e2){parsedData=responseData}}}this.#lastData=parsedData;this.#retryCount=0;if(this.#variable&&this.#variable.value!==undefined){this.#variable.value=parsedData}if(this.#templatePath&&this.#element){await this.#renderTemplate(parsedData)}else if(this.#element&&!this.#variable){this.#element.innerHTML=typeof parsedData==="string"?parsedData:JSON.stringify(parsedData)}if(this.#hooks.after.length>0){for(const fn of this.#hooks.after){try{await fn(parsedData,this.#element)}catch(e){console.warn("Error in after hook:",e)}}}}async#renderTemplate(data){if(!this.#element||!this.#templatePath)return;try{if(typeof $dotapp().fn==="function"){const templateFn=$dotapp().fn("template");if(templateFn){await $dotapp(this.#element).template(this.#templatePath,data)}}}catch(e){console.warn("Failed to render template:",e)}}#handleError(error){this.#retryCount++;if(this.#retryCount<this.#maxRetries){const delay=this.#retryDelay*Math.pow(2,this.#retryCount-1);setTimeout(()=>{this.#isLoading=false;this.#fetch()},delay);return}if(this.#hooks.onError.length>0){for(const fn of this.#hooks.onError){try{fn(error,this.#element)}catch(e){console.warn("Error in onError hook:",e)}}}else{console.error("Reactive endpoint error:",error)}}before(fn){this.#hooks.before.push(fn);return this}after(fn){this.#hooks.after.push(fn);return this}onError(fn){this.#hooks.onError.push(fn);return this}onResponseCode(code,fn){if(!this.#hooks.onResponseCode[code]){this.#hooks.onResponseCode[code]=[]}this.#hooks.onResponseCode[code].push(fn);return this}destroy(){if(this.#intervalId){clearInterval(this.#intervalId);this.#intervalId=null}}refresh(){this.#fetch()}}class DotAppReactiveEngine{#endpoints=new Map;#dotAppInstance=null;constructor(dotAppInstance){this.#dotAppInstance=dotAppInstance}createFromElement(element){const api=element.getAttribute("reactive-api");if(!api)return null;const config={api:api,method:element.getAttribute("reactive-method")||"GET",trigger:element.getAttribute("reactive-trigger"),variable:element.getAttribute("reactive-variable"),interval:element.getAttribute("reactive-interval"),key:element.getAttribute("reactive-key"),id:element.getAttribute("reactive-id"),data:element.getAttribute("reactive-data"),templatePath:element.getAttribute("reactive-template")};const endpointId=config.id||`reactive-${Date.now()}-${Math.random().toString(36).slice(2,9)}`;const endpoint=new ReactiveEndpoint(this.#dotAppInstance,element,config);this.#endpoints.set(endpointId,endpoint);return endpoint}create(url,config={}){const endpointId=config.id||`reactive-${Date.now()}-${Math.random().toString(36).slice(2,9)}`;const endpointConfig={api:url,method:config.method||"GET",trigger:config.trigger||null,variable:config.variable||null,interval:config.interval||null,key:config.key||"",id:endpointId,data:config.data||"",templatePath:config.template||null};const endpoint=new ReactiveEndpoint(this.#dotAppInstance,config.element||null,endpointConfig);this.#endpoints.set(endpointId,endpoint);const instance={before:fn=>{endpoint.before(fn);return instance},after:fn=>{endpoint.after(fn);return instance},onError:fn=>{endpoint.onError(fn);return instance},onResponseCode:(code,fn)=>{endpoint.onResponseCode(code,fn);return instance},refresh:()=>{endpoint.refresh();return instance},destroy:()=>{endpoint.destroy();this.#endpoints.delete(endpointId)}};return instance}initializeElements(){const reactiveElements=document.querySelectorAll("[reactive-api]");reactiveElements.forEach(element=>{element._reactiveData={api:element.getAttribute("reactive-api"),method:element.getAttribute("reactive-method"),trigger:element.getAttribute("reactive-trigger"),variable:element.getAttribute("reactive-variable"),interval:element.getAttribute("reactive-interval"),key:element.getAttribute("reactive-key"),id:element.getAttribute("reactive-id"),data:element.getAttribute("reactive-data"),template:element.getAttribute("reactive-template")};this.createFromElement(element);element.removeAttribute("reactive-api");element.removeAttribute("reactive-method");element.removeAttribute("reactive-trigger");element.removeAttribute("reactive-variable");element.removeAttribute("reactive-interval");element.removeAttribute("reactive-key");element.removeAttribute("reactive-id");element.removeAttribute("reactive-data");element.removeAttribute("reactive-template")})}getEndpoints(){return Array.from(this.#endpoints.values())}getEndpoint(id){return this.#endpoints.get(id)}destroyAll(){this.#endpoints.forEach(endpoint=>endpoint.destroy());this.#endpoints.clear()}}const engine=new DotAppReactiveEngine($dotapp());function initializeReactiveElements(){engine.initializeElements()}if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",initializeReactiveElements)}else{initializeReactiveElements()}window.addEventListener("dotapp-register",initializeReactiveElements);$dotapp().fn("reactive",function(url,config){if(typeof url==="string"){return engine.create(url,config||{})}return this});window.dispatchEvent(new Event("dotapp-reactive-ready"))};if(window.$dotapp){runMe(window.$dotapp)}else{window.addEventListener("dotapp-register",()=>runMe(window.$dotapp),{once:true})}})();